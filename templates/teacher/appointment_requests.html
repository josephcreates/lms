{% extends 'teacher/base_teacher.html' %}
{% block title %}Appointment Requests{% endblock %}

{% block content %}
<div class="container mt-4">
  <h4 class="mb-3">Appointment Requests</h4>

  <div class="card shadow-sm rounded-3">
    <div class="card-body p-0">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Student</th>
            <th>Date</th>
            <th>Time</th>
            <th>Note</th>
            <th>Status</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr>
            <td>{{ booking.student.user.full_name }}</td>
            <td>{{ booking.slot.date.strftime('%b %d, %Y') if booking.slot.date else '-' }}</td>
            <td>
              {% if booking.slot.start_time and booking.slot.end_time %}
                {{ booking.slot.start_time.strftime('%H:%M') }} - {{ booking.slot.end_time.strftime('%H:%M') }}
              {% else %} - {% endif %}
            </td>
            <td>{{ booking.note or '-' }}</td>
            <td>
              {% if booking.status == 'approved' %}
                <span class="badge bg-success">Approved</span>
              {% elif booking.status == 'declined' %}
                <span class="badge bg-danger">Declined</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if booking.status == 'pending' %}
                <!-- Action buttons now trigger confirmation modal -->
                <a href="{{ url_for('teacher.update_booking_status', booking_id=booking.id, status='approved') }}"
                   class="btn btn-success btn-sm me-1 confirm-action"
                   data-action="approve"
                   data-title="Approve appointment"
                   data-message="Approve appointment request from {{ booking.student.user.full_name }} on {{ booking.slot.date.strftime('%b %d, %Y') if booking.slot.date else 'the selected date' }}?"
                   title="Approve">
                  <i class="fas fa-check-circle"></i> Approve
                </a>

                <a href="{{ url_for('teacher.update_booking_status', booking_id=booking.id, status='declined') }}"
                   class="btn btn-danger btn-sm confirm-action"
                   data-action="decline"
                   data-title="Decline appointment"
                   data-message="Decline appointment request from {{ booking.student.user.full_name }} on {{ booking.slot.date.strftime('%b %d, %Y') if booking.slot.date else 'the selected date' }}?"
                   title="Decline">
                  <i class="fas fa-times-circle"></i> Decline
                </a>
              {% else %}
                <small class="text-muted">No action</small>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No appointment requests found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">Please confirm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        Are you sure?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

        <!-- Confirm button will perform the action (by navigating to URL) -->
        <a href="#" id="confirmModalAction" class="btn btn-primary">
          Confirm
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const confirmModalEl = document.getElementById('confirmModal');
      const bsModal = new bootstrap.Modal(confirmModalEl);
      const modalTitle = document.getElementById('confirmModalTitle');
      const modalBody = document.getElementById('confirmModalBody');
      const modalAction = document.getElementById('confirmModalAction');

      // Delegate clicks for all ".confirm-action" links (approve/decline)
      document.addEventListener('click', function (e) {
        const target = e.target.closest('.confirm-action');
        if (!target) return;

        e.preventDefault();
        const actionUrl = target.getAttribute('href');
        const title = target.dataset.title || 'Confirm action';
        const message = target.dataset.message || 'Are you sure you want to continue?';
        const actionType = target.dataset.action || 'confirm';

        // Update modal content
        modalTitle.textContent = title;
        modalBody.textContent = message;

        // Style the confirm button based on action
        modalAction.className = 'btn'; // reset
        if (actionType === 'approve') {
          modalAction.classList.add('btn', 'btn-success');
          modalAction.textContent = 'Approve';
        } else if (actionType === 'decline') {
          modalAction.classList.add('btn', 'btn-danger');
          modalAction.textContent = 'Decline';
        } else {
          modalAction.classList.add('btn', 'btn-primary');
          modalAction.textContent = 'Confirm';
        }

        // Set action (navigate to the actionUrl on confirm)
        modalAction.setAttribute('href', actionUrl);

        // Show modal
        bsModal.show();
      });

      // If you prefer to submit via fetch/AJAX, replace the click handler on modalAction
      // with fetch() and close modal on success; for now we keep navigation to preserve existing route behavior.
    })();
  </script>
{% endblock %}
