{% extends 'teacher/base_teacher.html' %}
{% block title %}Add New Assignment{% endblock %}

{% block content %}
<style>
  /* Smaller card and font */
  .card {
    font-size: 0.85rem;
  }

  .card-header h5 {
    font-size: 1rem;
    margin: 0;
  }

  .card-body {
    padding: 1rem 1.25rem !important;
  }

  .form-label {
    font-size: 0.8rem;
  }

  .form-control, .form-select {
    font-size: 0.85rem;
    padding: 0.35rem 0.6rem;
  }

  .btn {
    font-size: 0.8rem;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
  }

  h5.fw-bold {
    font-size: 0.95rem;
  }

  small {
    font-size: 0.75rem;
  }

  #filePreview {
    font-size: 0.8rem;
  }

  .toast .toast-body {
    font-size: 0.8rem;
  }
</style>

<div class="container mt-3">
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-header text-white rounded-top-3"
         style="background: linear-gradient(90deg, #2b2d42, #3a3d63);">
      <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Add New Assignment</h5>
    </div>

    <div class="card-body">
      <form id="wizardForm" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Step 1: Course & Class Info -->
        <div class="step">
          <h5 class="fw-bold mb-2">Course & Class</h5>
          <div class="row">
            <div class="col-md-6 mb-2">
              {{ form.course_name.label(class="form-label fw-semibold") }}
              {{ form.course_name(class="form-control", placeholder="e.g. Mathematics") }}
            </div>
            <div class="col-md-6 mb-2">
              {{ form.assigned_class.label(class="form-label fw-semibold") }}
              {{ form.assigned_class(class="form-select") }}
            </div>
          </div>
        </div>

        <!-- Step 2: Title -->
        <div class="step" style="display:none;">
          <h5 class="fw-bold mb-2">Assignment Title</h5>
          {{ form.title.label(class="form-label fw-semibold") }}
          {{ form.title(class="form-control", placeholder="Enter assignment title") }}
        </div>

        <!-- Step 3: Description -->
        <div class="step" style="display:none;">
          <h5 class="fw-bold mb-2">Description</h5>
          {{ form.description(class="form-control", rows=3, placeholder="Brief overview of the assignment") }}
        </div>

        <!-- Step 4: Instructions -->
        <div class="step" style="display:none;">
          <h5 class="fw-bold mb-2">Instructions</h5>
          {{ form.instructions(class="form-control", rows=3, placeholder="Detailed instructions for students") }}
        </div>

        <!-- Step 5: Due Date & Max Score -->
        <div class="step" style="display:none;">
          <h5 class="fw-bold mb-2">Schedule & Scoring</h5>
          <div class="row">
            <div class="col-md-6 mb-2">
              {{ form.due_date.label(class="form-label fw-semibold") }}
              {{ form.due_date(class="form-control", type="datetime-local") }}
            </div>
            <div class="col-md-6 mb-2">
              {{ form.max_score.label(class="form-label fw-semibold") }}
              {{ form.max_score(class="form-control", type="number", step="0.5", min="0", placeholder="e.g. 100") }}
            </div>
          </div>
        </div>

        <!-- Step 6: File Upload -->
        <div class="step" style="display:none;">
          <h5 class="fw-bold mb-2">Upload File (Optional)</h5>
          {{ form.file(class="form-control", onchange="previewFile()") }}
          <small class="text-muted">Upload reference files (PDF, DOCX, etc.)</small>
          <div id="filePreview" class="mt-2 text-success fw-semibold" style="display:none;"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-3">
          <button type="button" class="btn btn-outline-secondary" id="prevBtn"><i class="fas fa-arrow-left"></i> Back</button>
          <button type="button" class="btn btn-primary" id="nextBtn">Next <i class="fas fa-arrow-right"></i></button>
          <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">
            <i class="fas fa-save"></i> Save Assignment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-2" style="z-index: 1050">
  <div id="toastSuccess" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="fas fa-check-circle me-2"></i> Assignment saved successfully!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="fas fa-times-circle me-2"></i> Failed to save assignment.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
  // Wizard navigation
  const steps = document.querySelectorAll(".step");
  let currentStep = 0;
  showStep(currentStep);

  function showStep(n) {
    steps.forEach((step, i) => step.style.display = i === n ? "block" : "none");
    document.getElementById("prevBtn").style.display = n === 0 ? "none" : "inline-block";
    document.getElementById("nextBtn").style.display = n === steps.length - 1 ? "none" : "inline-block";
    document.getElementById("submitBtn").style.display = n === steps.length - 1 ? "inline-block" : "none";
  }

  document.getElementById("prevBtn").addEventListener("click", () => { if (currentStep > 0) showStep(--currentStep); });
  document.getElementById("nextBtn").addEventListener("click", () => { if (currentStep < steps.length - 1) showStep(++currentStep); });

  // File preview
  function previewFile() {
    const input = document.querySelector('input[type="file"]');
    const preview = document.getElementById('filePreview');
    if (input.files.length > 0) {
      preview.style.display = 'block';
      preview.innerHTML = `<i class="fas fa-file-alt"></i> ${input.files[0].name} (${(input.files[0].size/1024).toFixed(1)} KB)`;
    } else {
      preview.style.display = 'none';
    }
  }

  // AJAX form submission
  document.getElementById("wizardForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch("{{ url_for('teacher.add_assignment') }}", {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await response.json();
      if (data.success) {
        new bootstrap.Toast(document.getElementById("toastSuccess")).show();
        setTimeout(() => { window.location.href = "{{ url_for('teacher.manage_assignments') }}"; }, 1500);
      } else {
        new bootstrap.Toast(document.getElementById("toastError")).show();
      }
    } catch (error) {
      new bootstrap.Toast(document.getElementById("toastError")).show();
    }
  });
</script>
{% endblock %}
