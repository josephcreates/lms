{% extends 'admin/layout.html' %}
{% block title %}Manage Assignments{% endblock %}

{% block content %}
<div class="container-fluid mt-1">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">📘 Manage Assignments</h2>
    <a href="{{ url_for('admin.add_assignment') }}" class="btn btn-primary btn-sm">
      <i class="fas fa-plus"></i> Add Assignment
    </a>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Stats -->
  <div class="row mb-4">
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body py-2">
          <h6 class="text-muted">Total Assignments</h6>
          <h4 class="fw-bold">{{ assignments|length }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body py-2">
          <h6 class="text-muted">Upcoming</h6>
          <h4 class="fw-bold">
            {{ assignments|selectattr("due_date","gt",now)|list|length }}
          </h4>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body py-2">
          <h6 class="text-muted">Overdue</h6>
          <h4 class="fw-bold text-danger">
            {{ assignments|selectattr("due_date","lt",now)|list|length }}
          </h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="input-group mb-3 w-50">
    <span class="input-group-text">🔍</span>
    <input type="text" id="assignmentSearch" class="form-control" placeholder="Search assignments...">
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-hover table-sm align-middle" id="assignmentTable">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Course</th>
          <th>Class</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>File</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assignments %}
        <tr data-id="{{ a.id }}">
          <td>{{ a.title }}</td>
          <td>{{ a.course_name }}</td>
          <td>{{ a.assigned_class }}</td>
          <td>{{ a.due_date.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            {% if a.due_date > now %}
              <span class="badge bg-success">Upcoming</span>
            {% elif a.due_date.strftime('%Y-%m-%d') == now.strftime('%Y-%m-%d') %}
              <span class="badge bg-warning text-dark">Due Today</span>
            {% else %}
              <span class="badge bg-danger">Overdue</span>
            {% endif %}
          </td>
          <td>
            {% if a.filename %}
              <a href="{{ url_for('uploaded_file', filename=a.filename) }}" 
                class="btn btn-sm btn-outline-secondary" target="_blank">
                  📂 View
              </a>
            {% else %}
              <span class="text-muted">No file</span>
            {% endif %}
          </td>
          <td class="text-center">
            <div class="btn-group">
              <a href="{{ url_for('admin.edit_assignment', assignment_id=a.id) }}" 
                 class="btn btn-sm btn-outline-warning" title="Edit">✏️</a>
              <button class="btn btn-sm btn-outline-danger delete-btn"
                      data-url="{{ url_for('admin.delete_assignment', assignment_id=a.id) }}"
                      title="Delete">🗑️</button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No assignments available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.table th, .table td { padding: .6rem .8rem; font-size: 0.9rem; }
.card h4 { font-size: 1.4rem; margin: 0; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Live search
  const searchInput = document.getElementById('assignmentSearch');
  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll('#assignmentTable tbody tr').forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
    });
  });

  // AJAX delete
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!confirm("Delete this assignment?")) return;
      fetch(btn.dataset.url, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token() }}" }
      }).then(res => {
        if (res.ok) {
          btn.closest('tr').remove();
        } else {
          alert("Failed to delete assignment.");
        }
      });
    });
  });
});
</script>
{% endblock %}
