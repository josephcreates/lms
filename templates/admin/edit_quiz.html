{% extends 'admin/layout.html' %}
{% block title %}Edit Quiz | Admin Panel{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">Edit Quiz</h2>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">Quiz Information</div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="mb-3">
          {{ form.subject.label(class="form-label") }}
          {{ form.subject(class="form-control") }}
        </div>

        <div class="mb-3">
          {{ form.title.label(class="form-label") }}
          {{ form.title(class="form-control") }}
        </div>

        <div class="mb-3">
          {{ form.assigned_class.label(class="form-label") }}
          {{ form.assigned_class(class="form-select") }}
        </div>

        <div class="mb-3">
          <label class="form-label" for="start_datetime">Start Date &amp; Time</label>
          {{ form.start_datetime(class="form-control", id="start_datetime", type="datetime-local") }}
        </div>

        <div class="mb-3">
          <label class="form-label" for="end_datetime">End Date &amp; Time</label>
          {{ form.end_datetime(class="form-control", id="end_datetime", type="datetime-local") }}
        </div>

        <div class="mb-3">
          {{ form.duration.label(class="form-label") }}
          {{ form.duration(class="form-select") }}
        </div>

        <div class="mb-3">
          {{ form.attempts_allowed.label(class="form-label") }}
          {{ form.attempts_allowed(class="form-control", min="1", type="number") }}
        </div>

        <div class="mb-3">
          <label for="content_file" class="form-label">Upload File</label>
          <input type="file" class="form-control" name="content_file" id="content_file" accept=".pdf,.doc,.docx,.txt">
        </div>

        <!-- Quiz Questions -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">Quiz Questions</div>
          <div class="card-body">
            <div id="questions-container"></div>
            <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">+ Add Question</button>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          {{ form.submit(class="btn btn-success") }}
          <a href="{{ url_for('admin.manage_quizzes') }}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const quizQuestions = JSON.parse(`{{ quiz_questions|tojson|safe }}`);
  let questionCount = quizQuestions.length;
  const optionCounters = {};
  const labelStyles = {
    abc: ['a', 'b', 'c', 'd', 'e', 'f'],
    roman: ['i', 'ii', 'iii', 'iv', 'v', 'vi']
  };

  function addQuestionFromData(data, qIndex) {
    const container = document.getElementById('questions-container');
    const labelStyle = data.label_style || 'abc';

    const cardHtml = `
      <div class="card mb-3 shadow-sm border border-info" id="question-${qIndex}">
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label" for="question-text-${qIndex}">Question</label>
            <textarea
              id="question-text-${qIndex}"
              name="questions[${qIndex}][text]"
              class="form-control"
              required
            >${data.text || ''}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label" for="label-style-${qIndex}">Option Label Style</label>
            <select
              id="label-style-${qIndex}"
              class="form-select option-style-select"
              name="questions[${qIndex}][label_style]"
              onchange="updateOptionLabels(${qIndex})"
            >
              <option value="abc" ${labelStyle === 'abc' ? 'selected' : ''}>a, b, c, d</option>
              <option value="roman" ${labelStyle === 'roman' ? 'selected' : ''}>i, ii, iii, iv</option>
            </select>
          </div>
          <div class="option-container" id="options-${qIndex}"></div>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="addOption(${qIndex})">+ Add Option</button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOption(${qIndex})">− Remove Option</button>
          </div>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', cardHtml);
    optionCounters[qIndex] = 0;

    if (data.options) {
      data.options.forEach((opt) => {
        addOption(qIndex, opt.text, opt.is_correct);
      });
    }
  }

  function addOption(qIndex, optText = '', isCorrect = false) {
    const currentCount = optionCounters[qIndex] ?? 0;
    const oIndex = currentCount;
    optionCounters[qIndex] = currentCount + 1;

    const styleSelect = document.getElementById(`label-style-${qIndex}`);
    const style = styleSelect ? styleSelect.value : 'abc';
    const label = labelStyles[style][oIndex] || `opt${oIndex + 1}`;

    const checked = isCorrect ? 'checked' : '';

    const optionHtml = `
      <div class="input-group mb-2" id="question-${qIndex}-option-${oIndex}">
        <span class="input-group-text">${label}</span>
        <input type="text" class="form-control" name="questions[${qIndex}][options][${oIndex}][text]" value="${optText}" required />
        <span class="input-group-text">
          <input type="checkbox" name="questions[${qIndex}][options][${oIndex}][is_correct]" ${checked} />
          <span class="ms-1">✔</span>
        </span>
      </div>
    `;

    const optionsContainer = document.getElementById(`options-${qIndex}`);
    if (optionsContainer) {
      optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
    }
  }

  function removeOption(qIndex) {
    const count = optionCounters[qIndex] ?? 0;
    if (count > 0) {
      const oIndex = count - 1;
      optionCounters[qIndex] = oIndex;
      const optDiv = document.getElementById(`question-${qIndex}-option-${oIndex}`);
      if (optDiv) optDiv.remove();
    }
  }

  function updateOptionLabels(qIndex) {
    const styleSelect = document.getElementById(`label-style-${qIndex}`);
    const style = styleSelect ? styleSelect.value : 'abc';
    const container = document.getElementById(`options-${qIndex}`);
    if (!container) return;

    const optionGroups = container.querySelectorAll('.input-group');
    optionGroups.forEach((group, idx) => {
      const labelSpan = group.querySelector('.input-group-text');
      if (labelSpan) {
        labelSpan.textContent = labelStyles[style][idx] || `opt${idx + 1}`;
      }
    });
  }

  // Initialize questions
  quizQuestions.forEach((q, i) => {
    addQuestionFromData(q, i);
  });
</script>
{% endblock %}
