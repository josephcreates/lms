{% extends "parent/base_parent.html" %}
{% block title %}{{ student.user.full_name }} - Report{% endblock %}

{% block content %}
<div class="container mt-1 ">

  <!-- Student Info Card -->
  <div class="card shadow-sm border-0 mb-4 rounded-4">
    <div class="card-body">
      <h3 class="mb-2">{{ student.user.full_name }}</h3>
      <p class="mb-1"><strong>Current Class:</strong> {{ student.current_class }}</p>
      <p class="mb-0"><strong>Academic Year:</strong> {{ student.academic_year }}</p>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs nav-fill mb-3" id="reportTabs" role="tablist">
    {% set tabs = [
      {'id':'overview','label':'üìä Overview'},
      {'id':'quizzes','label':'üìù Quizzes'},
      {'id':'exams','label':'üß™ Exams'},
      {'id':'assignments','label':'üìÇ Assignments'},
      {'id':'attendance','label':'üìÖ Attendance'}
    ] %}
    {% for tab in tabs %}
      <li class="nav-item">
        <button class="nav-link {% if loop.first %}active{% endif %}" 
                id="{{ tab.id }}-tab" data-bs-toggle="tab" data-bs-target="#{{ tab.id }}">
          {{ tab.label }}
        </button>
      </li>
    {% endfor %}
  </ul>

  <div class="tab-content">

    <!-- Overview -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100 shadow-sm rounded-4 p-3">
            <h6 class="card-title mb-3">Grade Breakdown (Weighted)</h6>
            <canvas id="gradeBreakdownChart" style="max-height:300px;"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100 shadow-sm rounded-4 p-3">
            <h6 class="card-title mb-3">Attendance Summary</h6>
            <canvas id="attendanceChart" style="max-height:300px;"></canvas>
          </div>
        </div>
      </div>
      <div class="alert alert-info mt-4 rounded-4">
        <strong>Final Grade:</strong> {{ "%.1f"|format(final_percentage or 0) }}%
      </div>
    </div>

    <!-- Quizzes -->
    <div class="tab-pane fade" id="quizzes">
      {% if quiz_results %}
      <div class="table-responsive mb-3">
        <table class="table table-hover table-striped align-middle rounded-4">
          <thead class="table-light">
            <tr>
              <th>Quiz Title</th>
              <th>Subject</th>
              <th>Score</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
          {% for result in quiz_results %}
            <tr>
              <td>{{ result.quiz.title }}</td>
              <td><span class="badge bg-info">{{ result.quiz.subject }}</span></td>
              <td>{{ result.score }} / {{ result.quiz.total_score or result.quiz.max_score }}</td>
              <td>{{ result.submitted_at.strftime('%Y-%m-%d') if result.submitted_at else 'N/A' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card shadow-sm rounded-4 p-3 mb-3">
        <h6 class="card-title mb-3">Quiz Score Trend</h6>
        <canvas id="quizTrendChart" style="max-height:300px;"></canvas>
      </div>
      {% else %}
      <div class="alert alert-secondary rounded-4">No quiz results available.</div>
      {% endif %}
    </div>

    <!-- Exams -->
    <div class="tab-pane fade" id="exams">
      {% if exam_results %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle rounded-4">
          <thead class="table-light">
            <tr>
              <th>Exam</th>
              <th>Subject</th>
              <th>Score</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for ex in exam_results %}
            <tr>
              <td>{{ ex.exam.title }}</td>
              <td><span class="badge bg-primary">{{ ex.exam.subject }}</span></td>
              <td>{{ ex.score }} / {{ ex.exam.total_score }}</td>
              <td>{{ ex.submitted_at.strftime('%Y-%m-%d') if ex.submitted_at else 'N/A' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-secondary rounded-4">No exam records found.</div>
      {% endif %}
    </div>

    <!-- Assignments -->
    <div class="tab-pane fade" id="assignments">
      {% if assignment_results %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle rounded-4">
          <thead class="table-light">
            <tr>
              <th>Assignment</th>
              <th>Score</th>
              <th>Due Date</th>
            </tr>
          </thead>
          <tbody>
            {% for a in assignment_results %}
            <tr>
              <td>{{ a.assignment.title }}</td>
              <td>{{ a.score }} / {{ a.assignment.total_score }}</td>
              <td>{{ a.assignment.due_date.strftime('%Y-%m-%d') if a.assignment.due_date else 'N/A' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-secondary rounded-4">No assignment records found.</div>
      {% endif %}
    </div>

    <!-- Attendance -->
    <div class="tab-pane fade" id="attendance">
      {% if attendance_records %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle rounded-4">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Course</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for record in attendance_records %}
            <tr>
              <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
              <td>{{ record.course.name if record.course else 'N/A' }}</td>
              <td>
                {% if record.is_present %}
                <span class="badge bg-success">Present</span>
                {% else %}
                <span class="badge bg-danger">Absent</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-secondary rounded-4">No attendance records found.</div>
      {% endif %}
    </div>

  </div>

  <a href="{{ url_for('parent.reports_list') }}" class="btn btn-outline-secondary mt-4 rounded-4">‚¨Ö Back to Reports</a>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="application/json" id="report-data">
{
  "quizLabels": {{ quiz_results|map(attribute='quiz.title')|list|tojson }},
  "quizScores": {{ quiz_results|map(attribute='score')|list|tojson }},
  "examLabels": {{ exam_results|map(attribute='exam.title')|list|tojson }},
  "examScores": {{ exam_results|map(attribute='score')|list|tojson }},
  "assignLabels": {{ assignment_results|map(attribute='assignment.title')|list|tojson }},
  "assignScores": {{ assignment_results|map(attribute='score')|list|tojson }},
  "gradeWeighted": {
    "quizzes": {{ (quiz_weighted|default(0))|round(2) }},
    "exams": {{ (exam_weighted|default(0))|round(2) }},
    "assignments": {{ (assign_weighted|default(0))|round(2) }}
  },
  "attendanceCounts": {
    "present": {{ attendance_records|selectattr('is_present')|list|length }},
    "absent": {{ attendance_records|rejectattr('is_present')|list|length }}
  }
}
</script>

<script>
const reportData = JSON.parse(document.getElementById('report-data').textContent);

// Grade Breakdown
const gbCtx = document.getElementById('gradeBreakdownChart');
if (gbCtx) {
    new Chart(gbCtx, {
        type: 'doughnut',
        data: {
            labels: ['Quizzes','Exams','Assignments'],
            datasets: [{ 
                data: [
                    reportData.gradeWeighted.quizzes,
                    reportData.gradeWeighted.exams,
                    reportData.gradeWeighted.assignments
                ],
                backgroundColor: ['#36a2eb','#ff6384','#ffcd56']
            }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
    });
}

// Attendance Pie
const attCtx = document.getElementById('attendanceChart');
if (attCtx) {
    new Chart(attCtx, {
        type: 'pie',
        data: {
            labels: ['Present','Absent'],
            datasets: [{
                data: [reportData.attendanceCounts.present, reportData.attendanceCounts.absent],
                backgroundColor: ['#4caf50','#f44336']
            }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
    });
}

// Quiz Trend
const qtCtx = document.getElementById('quizTrendChart');
if (qtCtx && reportData.quizLabels.length > 0) {
    new Chart(qtCtx, {
        type: 'line',
        data: {
            labels: reportData.quizLabels,
            datasets: [{
                label: 'Quiz Scores',
                data: reportData.quizScores,
                borderColor: '#36a2eb',
                backgroundColor: '#36a2eb33',
                fill: true,
                tension: 0.2,
                pointRadius: 4
            }]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}
</script>

<style>
.card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); transition: 0.2s; }
.nav-tabs .nav-link { font-weight: 500; }
.table-hover tbody tr:hover { background-color: #f5f5f5; }
</style>
{% endblock %}
